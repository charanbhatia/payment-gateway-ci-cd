name: CD Pipeline - Kubernetes Deployment

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main, master]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/payment-gateway
  K8S_NAMESPACE: default
  APP_NAME: payment-gateway

jobs:
  # Stage 1: Deploy to Kubernetes
  deploy-to-kubernetes:
    name: Deploy to Kubernetes Cluster
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
          
      - name: Configure Kubernetes Context
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
      - name: Verify Kubernetes Connection
        run: |
          kubectl cluster-info
          kubectl get nodes
          
      - name: Update Image Tag in Deployment
        run: |
          # Update the image tag to use the latest from Docker Hub
          sed -i "s|image: .*|image: ${{ env.DOCKER_IMAGE }}:latest|g" k8s/deployment.yaml
          
      - name: Apply Kubernetes ConfigMap
        run: kubectl apply -f k8s/configmap.yaml -n ${{ env.K8S_NAMESPACE }}
        
      - name: Apply Kubernetes Secret
        run: kubectl apply -f k8s/secret.yaml -n ${{ env.K8S_NAMESPACE }}
        
      - name: Deploy Application to Kubernetes
        run: kubectl apply -f k8s/deployment.yaml -n ${{ env.K8S_NAMESPACE }}
        
      - name: Apply Kubernetes Service
        run: kubectl apply -f k8s/service.yaml -n ${{ env.K8S_NAMESPACE }}
        
      - name: Wait for Deployment Rollout
        run: |
          kubectl rollout status deployment/${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }} --timeout=5m
          
      - name: Verify Deployment
        run: |
          echo "ðŸ“Š Deployment Status:"
          kubectl get deployment ${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "ðŸ” Pods Status:"
          kubectl get pods -l app=${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "ðŸŒ Service Status:"
          kubectl get svc ${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }}
          
      - name: Get Application Logs
        if: always()
        run: |
          echo "ðŸ“ Application Logs:"
          kubectl logs -l app=${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }} --tail=50 || true

  # Stage 2: Smoke Tests
  smoke-tests:
    name: Post-Deployment Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-to-kubernetes
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
          
      - name: Configure Kubernetes Context
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
      - name: Get Service Endpoint
        id: get-endpoint
        run: |
          # Wait for service to be ready
          sleep 10
          
          # Get service endpoint (adjust based on your service type)
          SERVICE_IP=$(kubectl get svc ${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "")
          
          if [ -z "$SERVICE_IP" ]; then
            # If LoadBalancer IP not available, try NodePort
            NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}' || kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
            NODE_PORT=$(kubectl get svc ${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.spec.ports[0].nodePort}')
            SERVICE_URL="http://${NODE_IP}:${NODE_PORT}"
          else
            SERVICE_URL="http://${SERVICE_IP}:8080"
          fi
          
          echo "SERVICE_URL=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "ðŸŒ Service URL: ${SERVICE_URL}"
          
      - name: Test Health Endpoint
        run: |
          echo "Testing health endpoint..."
          for i in {1..30}; do
            if curl -f ${{ steps.get-endpoint.outputs.SERVICE_URL }}/actuator/health 2>/dev/null; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "Attempt $i: Waiting for service..."
            sleep 5
          done
          echo "âŒ Health check failed"
          exit 1
          
      - name: Test API Endpoints
        run: |
          BASE_URL="${{ steps.get-endpoint.outputs.SERVICE_URL }}"
          
          echo "Testing ping endpoint..."
          curl -f ${BASE_URL}/api/v1/payments/ping || exit 1
          
          echo "Testing info endpoint..."
          curl -f ${BASE_URL}/actuator/info || exit 1
          
          echo "âœ… All smoke tests passed!"

  # Stage 3: DAST - Dynamic Application Security Testing
  dast-scan:
    name: DAST - OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    needs: smoke-tests
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
          
      - name: Configure Kubernetes Context
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
      - name: Get Service Endpoint
        id: get-endpoint
        run: |
          SERVICE_IP=$(kubectl get svc ${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "")
          
          if [ -z "$SERVICE_IP" ]; then
            NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}' || kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
            NODE_PORT=$(kubectl get svc ${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.spec.ports[0].nodePort}')
            SERVICE_URL="http://${NODE_IP}:${NODE_PORT}"
          else
            SERVICE_URL="http://${SERVICE_IP}:8080"
          fi
          
          echo "SERVICE_URL=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "ðŸŒ Target URL for DAST: ${SERVICE_URL}"
          
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ steps.get-endpoint.outputs.SERVICE_URL }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false
          fail_action: false
          
      - name: Upload ZAP Scan Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30
          
      - name: Display DAST Summary
        if: always()
        run: |
          echo "ðŸ”’ DAST Scan Completed"
          echo "View detailed report in artifacts"
          if [ -f report_md.md ]; then
            echo "## ZAP Scan Summary"
            cat report_md.md || true
          fi

  # Stage 4: Deployment Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-to-kubernetes, smoke-tests, dast-scan]
    if: always()
    steps:
      - name: Generate Deployment Summary
        run: |
          echo "# ðŸš€ CD Pipeline Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Application**: Payment Gateway" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Kubernetes Cluster" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: ${{ env.K8S_NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.DOCKER_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Stages" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Kubernetes Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DAST Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review DAST scan results in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor application logs and metrics" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify application functionality" >> $GITHUB_STEP_SUMMARY
