name: CD Pipeline - Kubernetes Deployment

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main
      - master
  workflow_dispatch:

env:
  APP_NAME: payment-gateway
  K8S_NAMESPACE: default
  DOCKER_IMAGE: charanbhatia/payment-gateway

jobs:
  # Stage 1: Deploy to Kubernetes
  deploy:
    name: Deploy to Kubernetes Cluster
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Set up job
        run: echo "üöÄ Starting deployment to Kubernetes cluster"
        
      - name: Checkout source code
        uses: actions/checkout@v4
        
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
          
      - name: Configure Kubernetes Context
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
      - name: Verify Kubernetes Connection
        run: |
          kubectl cluster-info
          kubectl get nodes
          
      - name: Update Image Tag in Deployment
        run: |
          # Update the image tag to use the latest from Docker Hub
          sed -i '' "s|image: .*|image: ${{ env.DOCKER_IMAGE }}:latest|g" k8s/deployment.yaml
          
      - name: Apply Kubernetes ConfigMap
        run: kubectl apply -f k8s/configmap.yaml -n ${{ env.K8S_NAMESPACE }}
        
      - name: Apply Kubernetes Secret
        run: kubectl apply -f k8s/secret.yaml -n ${{ env.K8S_NAMESPACE }}
        
      - name: Deploy Application to Kubernetes
        run: kubectl apply -f k8s/deployment.yaml -n ${{ env.K8S_NAMESPACE }}
        
      - name: Apply Kubernetes Service
        run: kubectl apply -f k8s/service.yaml -n ${{ env.K8S_NAMESPACE }}
        
      - name: Wait for Deployment Rollout
        run: |
          kubectl rollout status deployment/${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }} --timeout=5m
          
      - name: Verify Deployment
        run: |
          echo "üìä Deployment Status:"
          kubectl get deployment ${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "üîç Pods Status:"
          kubectl get pods -l app=${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "üåê Service Status:"
          kubectl get svc payment-gateway-service -n ${{ env.K8S_NAMESPACE }}
          
      - name: Get Application Logs
        if: always()
        run: |
          echo "üìù Application Logs:"
          kubectl logs -l app=${{ env.APP_NAME }} -n ${{ env.K8S_NAMESPACE }} --tail=50 || true

  # Stage 2: Smoke Tests
  smoke-tests:
    name: Post-Deployment Smoke Tests
    runs-on: self-hosted
    needs: deploy
    steps:
      - name: Set up job
        run: echo "üß™ Running smoke tests"
        
      - name: Checkout source code
        uses: actions/checkout@v4
        
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
          
      - name: Configure Kubernetes Context
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
      - name: Test Health Endpoint
        run: |
          echo "Testing health endpoint..."
          SERVICE_URL="http://payment-gateway-service.default.svc.cluster.local/actuator/health"
          
          for i in {1..30}; do
            if kubectl run test-health-$i --image=curlimages/curl:latest --rm -i --restart=Never --command -- curl -f "$SERVICE_URL" 2>/dev/null; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            echo "Attempt $i: Waiting for service..."
            sleep 5
          done
          echo "‚ùå Health check failed"
          exit 1
          
      - name: Test API Endpoints
        run: |
          echo "Testing API endpoints..."
          
          echo "Testing ping endpoint..."
          kubectl run test-ping --image=curlimages/curl:latest --rm -i --restart=Never --command -- \
            curl -f http://payment-gateway-service.default.svc.cluster.local/api/v1/payments/ping || exit 1
          
          echo "Testing info endpoint..."
          kubectl run test-info --image=curlimages/curl:latest --rm -i --restart=Never --command -- \
            curl -f http://payment-gateway-service.default.svc.cluster.local/actuator/info || exit 1
          
          echo "‚úÖ All smoke tests passed!"

  # Stage 3: DAST - Dynamic Application Security Testing  
  dast-scan:
    name: DAST - OWASP ZAP Security Scan
    runs-on: self-hosted
    needs: smoke-tests
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
          
      - name: Configure Kubernetes Context
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
      - name: Setup Port Forward for DAST
        run: |
          # Start port forwarding in background
          kubectl port-forward svc/payment-gateway-service 8080:80 -n ${{ env.K8S_NAMESPACE }} &
          PF_PID=$!
          echo "PORT_FORWARD_PID=$PF_PID" >> $GITHUB_ENV
          
          # Wait for port forward to be ready
          sleep 5
          
          echo "üåê Port forward established (PID: $PF_PID)"
          
      - name: Run OWASP ZAP Baseline Scan
        continue-on-error: true
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false
          fail_action: false
          
      - name: Stop Port Forward
        if: always()
        run: |
          if [ -n "${{ env.PORT_FORWARD_PID }}" ]; then
            kill ${{ env.PORT_FORWARD_PID }} || true
          fi
          
      - name: Upload ZAP Scan Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30
          
      - name: Display DAST Summary
        if: always()
        run: |
          echo "üîí DAST Scan Completed"
          echo "View detailed report in artifacts"
          if [ -f report_md.md ]; then
            cat report_md.md
          fi

  # Stage 4: Deployment Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: self-hosted
    needs: [deploy, smoke-tests, dast-scan]
    if: always()
    steps:
      - name: Generate Deployment Report
        run: |
          echo "# üìã Deployment Summary"
          echo ""
          echo "## Application Details"
          echo "- **Application**: ${{ env.APP_NAME }}"
          echo "- **Namespace**: ${{ env.K8S_NAMESPACE }}"
          echo "- **Image**: ${{ env.DOCKER_IMAGE }}:latest"
          echo "- **Commit**: ${{ github.sha }}"
          echo ""
          echo "## Pipeline Stages"
          echo "- ‚úÖ Deployment: ${{ needs.deploy.result }}"
          echo "- ‚úÖ Smoke Tests: ${{ needs.smoke-tests.result }}"
          echo "- ‚úÖ DAST Scan: ${{ needs.dast-scan.result }}"
          echo ""
          echo "## Deployment Time"
          echo "- Completed at: $(date)"
          echo ""
          echo "üéâ CD Pipeline Completed Successfully!"
